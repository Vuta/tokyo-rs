<html>
    <head>
        <style>
            html, body, div, span, applet, object, iframe,
            h1, h2, h3, h4, h5, h6, p, blockquote, pre,
            a, abbr, acronym, address, big, cite, code,
            del, dfn, em, img, ins, kbd, q, s, samp,
            small, strike, strong, sub, sup, tt, var,
            b, u, i, center,
            dl, dt, dd, ol, ul, li,
            fieldset, form, label, legend,
            table, caption, tbody, tfoot, thead, tr, th, td,
            article, aside, canvas, details, embed,
            figure, figcaption, footer, header, hgroup,
            menu, nav, output, ruby, section, summary,
            time, mark, audio, video {
                margin: 0;
                padding: 0;
                border: 0;
                font-size: 100%;
                font: inherit;
                vertical-align: baseline;
                overflow:hidden;
            }

            #scoreboard {
                font-family: monospace;
                color: white;
                display: block;
                position: absolute;
                top: 10;
                left: 0;
            }
    </style>
    </head>
    <body>
        <canvas id="canvas" width="1200" height="800" style="border:1px solid #000000; background: #000;">
        </canvas>

        <div id="scoreboard">
            <h1>Scores</h1>
            <pre id="chart"></pre>
        </div>

        <script>
            var scoreboard = document.getElementById("scoreboard");
            var scoreboard_chart = document.getElementById("chart");
            var c = document.getElementById("canvas");
            window.onload = window.onresize = function() {
                c.width = document.body.clientWidth; //document.width is obsolete
                c.height = document.body.clientHeight; //document.height is obsolete
            }

            var ctx = c.getContext("2d");

            const socket = new WebSocket('ws://localhost:3000/spectate');
            socket.addEventListener('open', function (event) {
                console.log("connected!");
            });

            class Ship {
                constructor(obj) {
                    this.id = obj.id;
                    this.x = obj.x;
                    this.y = obj.y;
                    this.angle = obj.angle;
                }

                move(x, y) {
                    this.x = x;
                    this.y = y;
                }

                rotate(theta) {
                    this.angle = theta;
                }

                draw(ctx) {
                    // console.log(`S${this.id} (${this.x},${this.y})`);
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle - Math.PI / 2.0);
                    ctx.beginPath();
                    ctx.moveTo(-20, -25);
                    ctx.lineTo(0, 25);
                    ctx.lineTo(20, -25);
                    ctx.lineTo(-20, -25);
                    ctx.fill();
                    ctx.stroke();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                }
            }

            class Bullet {
                constructor(obj) {
                    this.id = obj.id;
                    this.player_id = obj.player_id;
                    this.x = obj.x;
                    this.y = obj.y;
                    this.angle = obj.angle;
                }

                move(x, y) {
                    this.x = x;
                    this.y = y;
                }

                rotate(theta) {
                    this.theta = theta;
                }

                draw(ctx) {
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    ctx.beginPath();
                    ctx.moveTo(-5, -5);
                    ctx.lineTo(0, 5);
                    ctx.lineTo(5, -5);
                    ctx.lineTo(-5, -5);
                    ctx.stroke();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                }
            }

            // Listen for messages
            socket.addEventListener('message', function (event) {
                let json = JSON.parse(event.data);
                if (json.e === "state") {
                    // console.log(json.data);
                    const data = json.data;

                    ctx.clearRect(0, 0, c.width, c.height);
                    ctx.strokeStyle = "#ffffff";
                    ctx.lineWidth = 1;
                    ctx.lineCap = "square";
                    ctx.lineJoin = "bevel";

                    // Draw the arena bounds
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(data.bounds[0], 0);
                    ctx.lineTo(data.bounds[0], data.bounds[1]);
                    ctx.lineTo(0, data.bounds[1]);
                    ctx.lineTo(0, 0);
                    ctx.stroke();

                    scoreboard.style.left = data.bounds[0] + 15;

                    for (const player of data.players) {
                        new Ship(player).draw(ctx);
                    }

                    for (const bullet of data.bullets) {
                        new Bullet(bullet).draw(ctx);
                    }
                    

                    chart.innerHTML = "";
                    for (const player_id of Object.keys(data.scoreboard)) {
                        chart.innerHTML += `${player_id}: ${data.scoreboard[player_id]}\n`;
                    }
                }
            });
        </script>
    </body>
</html>
