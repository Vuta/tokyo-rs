<html>
    <body>
        <canvas id="canvas" width="1200" height="800" style="border:1px solid #000000; background: #000;">
        </canvas>

        <div id="scoreboard"></div>

        <script>
            var scoreboard = document.getElementById("scoreboard");
            var c = document.getElementById("canvas");
            var ctx = c.getContext("2d");

            const socket = new WebSocket('ws://localhost:3000/spectate');
            socket.addEventListener('open', function (event) {
                console.log("connected!");
            });

            class Ship {
                constructor(obj) {
                    this.id = obj.id;
                    this.x = obj.x;
                    this.y = obj.y;
                    this.angle = obj.angle;
                }

                move(x, y) {
                    this.x = x;
                    this.y = y;
                }

                rotate(theta) {
                    this.angle = theta;
                }

                draw(ctx) {
                    // console.log(`S${this.id} (${this.x},${this.y})`);
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle - Math.PI / 2.0);
                    ctx.beginPath();
                    ctx.moveTo(-20, -25);
                    ctx.lineTo(0, 25);
                    ctx.lineTo(20, -25);
                    ctx.lineTo(-20, -25);
                    ctx.fill();
                    ctx.stroke();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                }
            }

            class Bullet {
                constructor(obj) {
                    this.id = obj.id;
                    this.player_id = obj.player_id;
                    this.x = obj.x;
                    this.y = obj.y;
                    this.angle = obj.angle;
                }

                move(x, y) {
                    this.x = x;
                    this.y = y;
                }

                rotate(theta) {
                    this.theta = theta;
                }

                draw(ctx) {
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    ctx.beginPath();
                    ctx.moveTo(-5, -5);
                    ctx.lineTo(0, 5);
                    ctx.lineTo(5, -5);
                    ctx.lineTo(-5, -5);
                    ctx.stroke();
                    ctx.setTransform(1, 0, 0, 1, 0, 0);
                }
            }

            // Listen for messages
            socket.addEventListener('message', function (event) {
                let json = JSON.parse(event.data);
                if (json.e === "state") {
                    // console.log(json.data);
                    const data = json.data;

                    ctx.clearRect(0, 0, c.width, c.height);
                    ctx.strokeStyle = "#ffffff";
                    ctx.lineWidth = 1;
                    ctx.lineCap = "square";
                    ctx.lineJoin = "bevel";

                    // Draw the arena bounds
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(512, 0);
                    ctx.lineTo(512, 512);
                    ctx.lineTo(0, 512);
                    ctx.lineTo(0, 0);
                    ctx.stroke();

                    for (const player of data.players) {
                        new Ship(player).draw(ctx);
                    }

                    for (const bullet of data.bullets) {
                        new Bullet(bullet).draw(ctx);
                    }
                    

                    scoreboard.innerHTML = "";
                    for (const player_id of Object.keys(data.scoreboard)) {
                        scoreboard.innerHTML += `${player_id}: ${data.scoreboard[player_id]}`;
                    }
                }
            });
        </script>
    </body>
</html>
